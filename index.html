<!DOCTYPE html>
<html>
<head>
    <title>AR with Marker</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.rawgit.com/ngokevin/kframe/master/components/gesture-detector/dist/gesture-detector.min.js"></script>
</head>
<body style='margin: 0; overflow: hidden;'>
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>
        <a-marker type='pattern' url='marker.patt' emitevents='true'>
            <a-entity id='marker-root' rotation='-90 0 0'>
                <a-image id='ar-image' src='image.png' position='0 0 0.5' scale='2 2 2' gesture-detector></a-image>
            </a-entity>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                enabled: { default: true },
                rotationFactor: { default: 5 },
                minScale: { default: 0.5 },
                maxScale: { default: 5 },
            },
            init: function () {
                this.initialDistance = null;
                this.initialScale = null;
                this.initialRotation = null;
                this.isVisible = false;
                this.el.sceneEl.addEventListener('markerFound', () => {
                    this.isVisible = true;
                });
                this.el.sceneEl.addEventListener('markerLost', () => {
                    this.isVisible = false;
                });
                this.el.sceneEl.addEventListener('gesture-detected', this.handleGesture.bind(this));
            },
            handleGesture: function (event) {
                if (!this.isVisible) return;

                if (event.detail.type === 'pinch') {
                    if (!this.initialScale) {
                        this.initialScale = this.el.object3D.scale.x;
                    }
                    const scaleFactor = event.detail.scale;
                    let newScale = this.initialScale * scaleFactor;
                    newScale = Math.min(Math.max(newScale, this.data.minScale), this.data.maxScale);
                    this.el.object3D.scale.set(newScale, newScale, newScale);
                }

                if (event.detail.type === 'rotate') {
                    if (!this.initialRotation) {
                        this.initialRotation = this.el.object3D.rotation.clone();
                    }
                    const deltaRotation = event.detail.rotation;
                    this.el.object3D.rotation.y = this.initialRotation.y + deltaRotation * this.data.rotationFactor / 1000;
                }

                if (event.detail.type === 'drag') {
                    if (this.initialRotation) {
                        const deltaX = event.detail.deltaX;
                        const deltaY = event.detail.deltaY;
                        this.el.object3D.rotation.y = this.initialRotation.y + deltaX * this.data.rotationFactor / 1000;
                        this.el.object3D.rotation.x = this.initialRotation.x - deltaY * this.data.rotationFactor / 1000;
                    }
                }
            }
        });

        AFRAME.registerComponent('markerhandler', {
            init: function () {
                const marker = this.el;
                const arImage = document.querySelector('#ar-image');
                marker.addEventListener('markerFound', () => {
                    arImage.setAttribute('visible', true);
                });
                marker.addEventListener('markerLost', () => {
                    arImage.setAttribute('visible', true); // 画像を表示したままにする
                });
            }
        });

        document.querySelector('a-marker').setAttribute('markerhandler', '');
        document.querySelector('#ar-image').setAttribute('gesture-handler', '');
    </script>
</body>
</html>
