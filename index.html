<!DOCTYPE html>
<html>
<head>
    <title>AR with Marker</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ngokevin/kframe/dist/gesture-detector.min.js"></script>
</head>
<body style='margin: 0; overflow: hidden;'>
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;'>
        <a-marker preset="custom" type="pattern" url="marker.patt" emitevents="true">
            <a-image id="ar-image" src="image.png" position="0 0 0.5" rotation="-90 0 0" scale="2 2 2" gesture-detector></a-image>
        </a-marker>
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        AFRAME.registerComponent('gesture-handler', {
            schema: {
                rotationFactor: { type: 'number', default: 5 },
                minScale: { type: 'number', default: 0.5 },
                maxScale: { type: 'number', default: 5 }
            },
            init: function () {
                this.initialScale = this.el.object3D.scale.clone();
                this.initialRotation = this.el.object3D.rotation.clone();
                this.initialDistance = null;
                this.el.sceneEl.addEventListener('gesture-detector-pinchstarted', this.onPinchStart.bind(this));
                this.el.sceneEl.addEventListener('gesture-detector-pinchmoved', this.onPinchMove.bind(this));
                this.el.sceneEl.addEventListener('gesture-detector-rotatestarted', this.onRotateStart.bind(this));
                this.el.sceneEl.addEventListener('gesture-detector-rotatemoved', this.onRotateMove.bind(this));
            },
            onPinchStart: function (event) {
                this.initialDistance = event.detail.distance;
                this.initialScale = this.el.object3D.scale.clone();
            },
            onPinchMove: function (event) {
                const scaleFactor = event.detail.distance / this.initialDistance;
                const newScale = this.initialScale.clone().multiplyScalar(scaleFactor);
                newScale.clampScalar(this.data.minScale, this.data.maxScale);
                this.el.object3D.scale.set(newScale.x, newScale.y, newScale.z);
            },
            onRotateStart: function (event) {
                this.initialRotation = this.el.object3D.rotation.clone();
            },
            onRotateMove: function (event) {
                const newRotation = this.initialRotation.y + THREE.Math.degToRad(event.detail.angle * this.data.rotationFactor);
                this.el.object3D.rotation.y = newRotation;
            }
        });

        AFRAME.registerComponent('markerhandler', {
            init: function () {
                const marker = this.el;
                const arImage = document.querySelector('#ar-image');
                marker.addEventListener('markerFound', () => {
                    arImage.setAttribute('visible', true);
                });
                marker.addEventListener('markerLost', () => {
                    arImage.setAttribute('visible', true); // 画像を表示したままにする
                });
            }
        });

        document.querySelector('a-marker').setAttribute('markerhandler', '');
        document.querySelector('#ar-image').setAttribute('gesture-handler', '');
    </script>
</body>
</html>
